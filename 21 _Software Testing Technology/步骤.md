```shell
python manage.py runserver #启动服务器
python functional_tests.py #功能测试
python manage.py test functional_tests #第六章后的功能测试
python manage.py test #单元测试
python manage.py test lists #第六章后的单元测试
  
python manage.py makemigrations #数据库迁移命令
python manage.py migrate #创建数据库

STAGING_SERVER=39.96.9.216 python3 manage.py test functional_tests ##有服务器后在本地功能测试
../virtualenv/bin/python manage.py test functional_tests #在服务器功能测试
../virtualenv/bin/python manage.py test lists #在服务器单元测试
```
## 第一章

1. Anaconda Prompt中运行`pip install Django`进行安装。

2. 编写functional_tests.py
```python
from selenium import webdriver
browser = webdriver.Chrome()
browser.get('http://localhost:8000')
assert 'Django' in browser.title
```

3. 跳转到该目录下或powershell输入`django-damin.py startproject suplerlists`

4. Anaconda Prompt运行`python manage.py runserver`

5. Spyder中运行functional_tests.py，显示成功

6. 目录下打开Linux Shell看一看。同步到github，下略。
```shell
ls
mv functional_tests.py superlists/
cd superlists
```

## 第二章

1. 关掉所有的，更新functional_tests.py代码（第23张ppt）

2. 到目录\21 _Software Testing Technology\suplerlists处Anaconda Prompt处启动`python manage.py runserver`

3. Anaconda Prompt到目录处运行测试`python functional_tests.py`
4. 新建functional_tests2.py并添加代码 (第30张ppt)

5. Anaconda Prompt运行`python functional_tests2.py`

## 第三章

1. Anaconda Prompt到目录处`python manage.py startapp lists`

2. 编辑list下的test.py如下，Anaconda Prompt到目录处运行`python manage.py test`
```python
from django.test import TestCase
class SmokeTest(TestCase):
    def test_bad_maths(self):
   	 self.assertEqual(1 + 1, 3)
```

3. 编辑list下的test.py如下，Anaconda Prompt到目录处运行`python manage.py test`
```python
from django.urls import resolve
from django.test import TestCase
from lists.views import home_page
class HomePageTest(TestCase):
    def test_root_url_resolves_to_home_page_view(self):
        found = resolve('/')
        self.assertEqual(found.func, home_page)
```

## 第三章续

4. 上接3步，编辑好test.py。到目录处Anaconda Prompt运行`python manage.py runserver`

5. 到目录处新开一个Anaconda Prompt，并运行（在目录处，下略）`python manage.py test`

6. 编辑views.py，添加如下后，在Anaconda Prompt重新运行`python manage.py test`
```python
from django.shortcuts import render
home_page = None
```

7. suplerlists\suplerlists中打开urls.py并改成如下后，在Anaconda Prompt运行`python manage.py test`
```python
from django.contrib import admin
from django.urls import path
from django.conf.urls import url
from lists import views
urlpatterns = [
    #path('admin/', admin.site.urls),
    url(r'^$',views.home_page,name='home'),
]
```

8. views.py改成如下，Anaconda Prompt运行`python manage.py test`并显示成功。
```python
from django.shortcuts import render
def home_page():
    pass
```

9. 修改test.py如下后并在Anaconda Prompt运行`python manage.py test`
```python
from django.urls import resolve
from django.test import TestCase
from django.http import HttpRequest
from lists.views import home_page
class HomePageTest(TestCase):
    def test_root_url_resolves_to_home_page_view(self):
        found = resolve('/')
        self.assertEqual(found.func, home_page)
    def test_home_page_returns_correct_html(self):
        request = HttpRequest()
        response = home_page(request)
        html = response.content.decode('utf8')
        self.assertTrue(html.startswith('<html>'))
        self.assertIn('<title>To-Do lists</title>', html)
        self.assertTrue(html.endswith('</html>'))
```

10. 多次修改view.py，最终改成如下后，在Anaconda Prompt中运行单元测试`python manage.py test`，并显示成功。在Anaconda Prompt运行功能测试，注意是tests2.py
 `python functional_tests2.py`。
```python
from django.shortcuts import render
from django.http import HttpResponse
def home_page(request):
     return HttpResponse('<html><title>To-Do lists</title></html>')
```

## 第四章

1.  TDD是一个长期的东西
2. Anaconda Prompt再运行一次功能测试`python functional_tests2.py`(如提示To-Do错误可能没开服务器)

3. 新建functional_tests3.py并添加代码 (第102张ppt，或4.pdf的41页)

4. Anaconda Prompt运行`python functional_tests3.py`，会提示`Unable to locate element: {"method":"tag name","selector":"h1"}`

## 第四章续

1. Anaconda Prompt并运行单元测试`python manage.py test`，并提示成功

2. list目录下创建templates文件夹，并创建home.html文件，并填写
```html
<html>
    <title>To-Do lists</title>
</html>
```

3. 修改views.py为如下，后运行`python manage.py test`，出现错误提示。
```python
from django.shortcuts import render
def home_page(request):
    return render(request, 'home.html')
```

4. 打开settings.py，在INSTALLED_APPS中添加  `'lists',`

5. 运行`python manage.py test`，会有如下错误。（文本编译器不同，一般不会出错）（是断言home.html末尾是不是</html>）
```shell
    self.assertTrue(html.endswith('</html>'))
AssertionError: False is not true
```

6.  查看test.py代码，修改以下函数如下，见4.pdf的47页。
```python
 from django.template.loader import render_to_string
 	def test_home_page_returns_correct_html(self):
           request = HttpRequest()
           response = home_page(request)
           html = response.content.decode('utf8')
           expected_html = render_to_string('home.html')
           self.assertEqual(html, expected_html)
```

7. 再把以上函数改成见4.pdf的47页下方的代码。②和③一样。删掉②后如下，同时修改函数名为test_uses_home_template。运行`python manage.py test`，提示成功。
```python
           response = self.client.get('/')
           self.assertTemplateUsed(response, 'home.html')
```

8. 可以改成`self.assertTemplateUsed(response, 'hom2e.html')` 后再运行`python manage.py test`，会出现错误提示 `Template 'hom2e.html' was not a template used to render the response. Actual template(s) used: home.html`。再改成正确的。此时也可以把test_root_url_resolves_to_home_page_view函数删掉了。

9. git中commit。修改home.html为如下，并`python functional_tests3.py`，提示 Unable to locate element: {"method":"id","selector":"id_new_item"}
```html
<html>
    <head>
        <title>To-Do lists</title>
    </head>
    <body>
        <h1>Your To-Do list</h1>
    </body>
</html>
```

10. 多次修改home.html直至如下，并`python functional_tests3.py`，会提示any(row.text == '1: Buy peacock feathers' for row in rows)。
```html
<html>
    <head>
        <title>To-Do lists</title>
    </head>
     <body>
        <h1>Your To-Do list</h1>
         <input id="id_new_item" placeholder="Enter a to-do item" />
        <table id="id_list_table">
    </body>
</html>
```

11. functional_tests3.py中（见4.pdf的52页）添加`"New to-do item did not appear in table"`后，并`python functional_tests3.py`，会提示AssertionError: False is not true : New to-do item did not appear in table。

## 续第五章

1. 修改home.html文件，中间部分几行修改如下，并功能测`python functional_tests3.py`，浏览器会提示Forbidden 403，CSRF verification failed，命令行会提示no such element: Unable to locate element: {"method":"id","selector":"id_list_table"}。
```html
   <form method="POST">
  <input name="item_text" id="id_new_item" placeholder="Enter a to-do item" />
   </form>
```

2. 如需要调试，可将functional_tests3.py中的time.sleep(1)改成10等时间。

3. 查看浏览器中详细的错误信息与建议，修改home.html如下，命令行会提示False is not true : New to-do item did not appear in table。
```html
           <form method="POST">
           <input name="item_tetxt" id="id_new_item" placeholder="Enter a to-do item" />
           {啊%csrf_toke%啊}
           </form>
```

4. 可以将sleep改回来。

5. 修改test.py，添加以下函数，并运行单元测`python manage.py test`。命令行会提示`A new list item' not found in <html>\n......`，
```python
   def test_can_save_a_POST_request(self):
       response = self.client.post('/', data={'item_text': 'A new list item'})
       self.assertIn('A new list item', response.content.decode())
```

6. 修改views.py，假装让测试通过。并运行单元测`python manage.py test`。测试通过。
```python
   def home_page(request):
       if request.method == 'POST':
           return HttpResponse(request.POST['item_text'])
       return render(request, 'home.html')
```

7. 修改home.html中部分内容，如下。修改test.py中的test_can_save_a_POST_request函数为如下。并运行单元测`python manage.py test`，会提示AssertionError: No templates used to render the response。
```html
   <table id="id_list_table">
       <tr><td>{{ new_item_text }}</td></tr>
   </table>
```

```python
   def test_can_save_a_POST_request(self):
       response = self.client.post('/', data={'item_text': 'A new list item'})
       self.assertIn('A new list item', response.content.decode())
       self.assertTemplateUsed(response, 'home.html')
```

8. 修改views.py的函数如下，并运行单元测`python manage.py test`，会提示 request.POST['item_text']等。
```python
    return render(request, 'home.html', {
            'new_item_text': request.POST['item_text'],
    })
```

9. 修改views.py的函数如下，并运行功能测`python functional_tests3.py`，会提示False is not true : New to-do item did not appear in table等。
```python
    return render(request, 'home.html', {
            'new_item_text': request.POST.get('item_text', ''),
    })
```

10. 修改functional_tests3.py中函数的内容如下，运行`python functional_tests3.py`后提示False is not true : New to-do item did not appear in table. Contents were:Buy peacock feathers，were后如果为空说明home.html写错了。
```python
   self.assertTrue(
       any(row.text == '1: Buy peacock feathers' for row in rows),
       f"New to-do item did not appear in table. Contents were:\n{table.text}"
      )
```

11. 上面四行改为，运行`python functional_tests3.py`后会提示AssertionError: '1: Buy peacock feathers' not found in ['Buy peacock feathers']
```python
 self.assertIn('1: Buy peacock feathers', [row.text for row in rows]
```

12. 可修改home.html中代码为`<tr><td>1: {{ new_item_text }}</td></tr>`

13. 修改functional_tests3.py为functional_tests4.py中的代码，运行`python functional_tests4.py`后会提示AssertionError: '1: Buy peacock feathers' not found in ['Buy peacock feathers']

14. functional_tests4.py中的tearDown函数下添加如下函数。
```python
 def check_for_row_in_list_table(self, row_text):
    table = self.browser.find_element_by_id('id_list_table')
    rows = table.find_elements_by_tag_name('tr')
    self.assertIn(row_text, [row.text for row in rows])
```

15. 修改为functional_tests5.py中的代码，运行`python functional_tests5.py`后会提示AssertionError: '1: Buy peacock feathers' not found in ['Buy peacock feathers']

16. 修改tests.py函数如下，添加新的类，运行`python manage.py test`，会提示ImportError: cannot import name 'Item'
```python
from lists.models import Item
class ItemModelTest(TestCase):
     def test_saving_and_retrieving_items(self):
         略，见5.pdf的66页
```

17. 修改models.py如下，添加如下代码后再运行`python manage.py test`，会提示AttributeError: 'Item' object has no attribute 'save'。修改代码`Item`为`Item(models.Model)`，再运行`python manage.py test`，会有很多错误和django.db.utils.OperationalError: no such table: lists_item提示。
```python
class Item(object):
    pass
```

18. 数据库迁移命令`python manage.py makemigrations`，会提示- Create model Item。也可以看到新建了migrations文件夹，下有0001_initial.py、____init____.py和____pycache____文件夹。

19. 运行单元测试`python manage.py test lists`，提示AttributeError: 'Item' object has no attribute 'text'。

20. 修改models.py函数内容为`text = models.TextField()`，运行`python manage.py test lists`，会提示django.db.utils.OperationalError: no such column: lists_item.text。运行`python manage.py makemigrations`，并输入2退出。修改models.py函数内容为`text = models.TextField(default='')`，运行`python manage.py makemigrations`，会提示    - Add field text to item。最后运行`python manage.py test lists`，会提示OK通过。

## 第五章续

1. 在test.py中的test_can_save_a_POST_request(self)函数插入如下三行代码，从第二行起插入。运行`python manage.py test lists`，会提示AssertionError: 0 != 1错误。
```python
self.assertEqual(Item.objects.count(), 1)
new_item = Item.objects.first()
self.assertEqual(new_item.text, 'A new list item')
```

2. 在views.py中插入三行如下代码，在home_page(request)函数第一行起插入。运行`python manage.py test lists`，会提示OK。
```python
from lists.models import Item
item = Item()
item.text = request.POST.get('item_text', '')
item.save()
```

3. 修改views.py中return部分代码如下来重构。运行`python manage.py test lists`，会提示OK。
```python
     return render(request, 'home.html', {
            'new_item_text': item.text
    })
```

4. 在tests.py的HomePageTest类中添加如下代码。运行`python manage.py test lists`，会提示AssertionError: 1 != 0。
```python
def test_only_saves_items_when_necessary(self):
    self.client.get('/')
    self.assertEqual(Item.objects.count(), 0)
```

5. 修改views.py代码如下，运行`python manage.py test`，会提示OK。
```python
    if request.method == 'POST':
        new_item_text = request.POST['item_text']
        Item.objects.create(text=new_item_text)
    else:
        new_item_text = ''
    return render(request, 'home.html', {
            'new_item_text': new_item_text
    })
```

6. **Redirect after a POST。**修改tests.py代码test_can_save_a_POST_request函数部分。运行`python manage.py test`，会提示AssertionError: 200 != 302。
```python
self.assertEqual(response.status_code, 302)
self.assertEqual(response['location'], '/')
```

7. 修改views.py代码如下，运行`python manage.py test`，会提示OK。
```python
from django.shortcuts import redirect
def home_page(request):
    if request.method == 'POST':
        Item.objects.create(text=request.POST['item_text'])
        return redirect('/')
    return render(request, 'home.html')
```

8. **Better Unit Testing Practice: Each Test Should Test One Thing。**修改tests.py中的test_can_save_a_POST_request函数，并添加如下函数。运行`python manage.py test`，会提示OK。
```python
def test_redirects_after_POST(self):
    response = self.client.post('/', data={'item_text': 'A new list item'})
    self.assertEqual(response.status_code, 302)
    self.assertEqual(response['location'], '/')
```

9. **Rendering Items in the Template。**在tests.py中添加如下代码。运行`python manage.py test`，会提示AssertionError: "itemey 1" not found in `<html>`\n等。
```python
def test_displays_all_list_items(self):
    Item.objects.create(text='itemey 1')
    Item.objects.create(text='itemey 2')
    #
    response = self.client.get('/')
    #
    self.assertIn('itemey 1', response.content.decode())
    self.assertIn('itemey 2', response.content.decode())
```

10. 在home.html中添加`{啊% for item in items %啊} <tr><td>1: {{ item.text }}</td></tr> {啊% endfor %啊}`语句，修改views.py中部分代码如下，运行`python manage.py test`，会提示OK。
```python
items = Item.objects.all()
return render(request, 'home.html', {'items': items})
```

11. 运行功能测试，`python functional_tests5.py`，会提示AssertionError: 'To-Do' not found in 'OperationalError at /'。浏览器访问http://localhost:8000/ ，可以看到错误的具体原因。

12. **Creating Our Production Database with migrate。**打开settings.py，可以看到DATABASES字段。输入`python manage.py migrate`创建数据库，可以看到文件夹内多了db.sqlite3文件。

13. 运行功能测试，`python functional_tests5.py`，会提示AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy peacock feathers', '1: Use peacock feathers to make a fly']。修改home.html中部分代码为`<tr><td>{{ forloop.counter }}: {{ item.text }}</td></tr>`，运行功能测试，`python functional_tests5.py`，可以看到浏览器依次显示如下内容，命令行中显示AssertionError: Finish the test!。多次运行功能测试，`python functional_tests5.py`，浏览器中还会继续出现如下下方的内容。
```python
1: Buy peacock feathers
2: Use peacock feathers to make a fly
3: Buy peacock feathers
4: Use peacock feathers to make a fly
```

```python
5: Buy peacock feathers
6: Use peacock feathers to make a fly
```

14. 可以通过`rm db.sqlite3`和`python manage.py migrate --noinput`删掉，windows需关掉服务器后在Linux shell输入第一个命令，然后在anaconda promopt中输入第二个命令。重启服务器，可以看到浏览器中没有了上述的内容。

## 第六章

1. 新建文件夹和文件，mkdir functional_tests和touch functional_tests/____init____.py。接着输入git mv functional_tests5.py functional_tests/tests.py将functional_tests5.py移动到新建的文件夹里面并重命名。可以git status查看。

2. 以后使用`python manage.py test functional_tests`来功能测试。

## 第六章续

3. functional_tests下的tests.py中修改下面部分代码。删掉`if ____name____ == '__main__':`及后面代码。运行`python manage.py test functional_tests`后会提示AssertionError: Finish the test!
```python
from django.test import LiveServerTestCase
class NewVisitorTest(LiveServerTestCase):
    def test_can_start_a_list_and_retrieve_it_later(self):
        self.browser.get(self.live_server_url)
```

4. 运行单元测`python manage.py test`，功能测试和单元测就一起运行了，AssertionError: Finish the test!且Ran 7 tests in 7.282s（功能测1个，单元测6个）。可以运行`python manage.py test lists`，看到Ran 6 tests in 0.055s和OK。
5. 以后使用`python manage.py test lists`来单元测试。
6. **On Implicit and Explicit Waits, and Voodoo time.sleeps。**functional_tests下的tests.py中添加如下代码，同时删掉`check_for_row_in_list_table`函数，添加见6.pdf的90页 `wait_for_row_in_list_table`函数。删掉`test_can_start_a_list_and_retrieve_it_later`函数中的`time.sleep(1)`代码，同时把调用前者函数的部分改成调用`wait_for_row_in_list_table`函数。运行`python manage.py test`后会提示AssertionError: Finish the test!和Ran 7 tests in 5.250s，时间变短了。

```python
   from selenium.common.exceptions import WebDriverException
   MAX_WAIT = 10
```

7. 故意以几种方式打破错误。`wait_for_row_in_list_table`函数中的部分，改成`self.assertIn('foo', [row.text for row in rows])`，等待两次后，上面会出现一个AssertionError: 'foo' not found in ['1: Buy peacock feathers']。撤销修改。改成`table = self.browser.find_element_by_id('id_nothing')`，等待两次后，上面会出现一个Unable to locate element: {"method":"id","selector":"id_nothing"}。撤销修改。运行`python manage.py test`，提示AssertionError: Finish the test!。

## 第七章

1. **Ensuring We Have a Regression Test。**functional_tests下的tests.py中test_can_start_a_list_and_retrieve_it_later函数更名为test_can_start_a_list_for_one_user，并修改和删除部分如下，添加见7.pdf的99和100页的函数test_multiple_users_can_start_lists_at_different_urls。运行功能测试`python manage.py test functional_tests`后会提示Regex didn''t match: '/lists/.+' not found in 'http://localhost:14533/'和Ran 2 tests in 10.339s和FAILED (failures=1)。
```python
   # The page updates again, and now shows both items on her list
   self.wait_for_row_in_list_table('2: Use peacock feathers to make a fly')
   self.wait_for_row_in_list_table('1: Buy peacock feathers')
   # Satisfied, she goes back to sleep
```

## 第七章续

2. **Iterating Towards the New Design**。修改lists文件夹内tests.py的test_redirects_after_POST(self)函数最后一行为`self.assertEqual(response['location'], '/lists/the-only-list-in-the-world/')`。运行单元测python manage.py test lists，会提示AssertionError: '/' != '/lists/the-only-list-in-the-world/'。

3. 修改lists文件夹内views.py，其中一行为return redirect('/lists/the-only-list-in-the-world/')，运行功能测试`python manage.py test functional_tests`，FAILED (errors=2)都失败了。在lists文件夹tests.py添加新的测试类，将test_displays_all_list_items函数内容复制到类下并修改为如下。运行单元测试`python manage.py test lists`，提示网址不存在Response code was 404 (expected 200)和......F，前面六个用例通过第七个F失败。
```python
   class ListViewTest(TestCase):
   def test_displays_all_items(self):
       Item.objects.create(text='itemey 1')
       Item.objects.create(text='itemey 2')
       response = self.client.get('/lists/the-only-list-in-the-world/')
       self.assertContains(response, 'itemey 1')
       self.assertContains(response, 'itemey 2')
```

4. 修改urls.py一部分如下，运行单元测试`python manage.py test lists`，会提示 module 'lists.views' has no attribute 'view_list'。
```python
       url(r'^$', views.home_page, name='home'),
       url(r'^lists/the-only-list-in-the-world/$', views.view_list, name='view_list'),
```

5. lists文件夹views.py修改一部分如下，运行单元测试`python manage.py test lists`会提示ValueError: The view lists.views.view_list didn''t return an HttpResponse object. It returned None instead.和FAILED (errors=1)。继续修改一部分如下方下面，运行单元测试`python manage.py test lists`会提示OK。运行功能测试`python manage.py test functional_tests`，后会提示AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy peacock feathers']等错误。
```python
   def view_list(request):
   	pass
```

```python
   def view_list(request):
       items = Item.objects.all()
       return render(request, 'home.html', {'items': items})
```

   >单元测试是逻辑测试，不测试内容。单元测都过了逻辑没问题，view、url没问题。但没覆盖到内容，在template里面。
   >

6. 修改lists文件夹templates/home.html中一行代码为`<form method="POST" action="/">`，运行功能测试`python manage.py test functional_tests`，之前的第一个过了，测两个人的没过。FAILED (errors=1)和AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do list\n1: Buy peacock feathers'。

   > Message: 'geckodriver' executable needs to be in PATH.是因为functional_tests\tests.py中的代码写成了webdriver.Firefox()。

7. **Green? Refactor**。在Linux shell中输入grep -E "class|def" lists/tests.py，可以看到下面部分。删掉lists/tests.py中HomePageTest类中的test_displays_all_list_items函数。此时运行单元测试`manage.py test lists`会显示Ran 6 tests in 0.031s而不是之前的七个。
```python
   class HomePageTest(TestCase):
    def test_uses_home_template(self):
    def test_can_save_a_POST_request(self):
    def test_redirects_after_POST(self):
    def test_only_saves_items_when_necessary(self):
    def test_displays_all_list_items(self):
   class ItemModelTest(TestCase):
    def test_saving_and_retrieving_items(self):
   class ListViewTest(TestCase):
    def test_displays_all_items(self):
```

8. **Another Small Step: A Separate Template for Viewing Lists**。lists/tests.py的ListViewTest类下添加如下函数。运行单元测试`manage.py test lists`会提示False is not true : Template 'list.html' was not a template used to render the response. Actual template(s) used: home.html。
```python
   def test_uses_list_template(self):
    response = self.client.get('/lists/the-only-list-in-the-world/')
    self.assertTemplateUsed(response, 'list.html')
```

9. 修改Views.py内view_list函数的一行代码为`return render(request, 'list.html', {'items': items})`，运行单元测试`manage.py test lists`会提示django.template.exceptions.TemplateDoesNotExist: ltst.html。在suplerlists\lists\templates目录下新建list.html文件。运行单元测试manage.py test lists会提示False is not true : Couldn''t find 'itemey 1' in response。将home.html内容拷贝到list.html中，运行单元测试manage.py test lists会提示Ran 7 tests in 0.047s和OK。

10. 修改home.html代码如下，注意保留其余部分。运行单元测试manage.py test lists会提示Ran 7 tests in 0.052s和OK。
```html
<body>
    <h1>Start a new To-Do list</h1>
    <form method="POST">
       <input name="item_text" id="id_new_item" placeholder="Enter a to-do item" />
       {啊% csrf_token %啊}
    </form>
</body>
```

11. 修改lists/views.py的home_page代码如下，最后两行有改动。运行功能测试`python manage.py test functional_tests`，提示AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy milk']
```python
if request.method == 'POST':
    Item.objects.create(text=request.POST['item_text'])
    return redirect('/lists/the-only-list-in-the-world/')
return render(request, 'home.html')
```

12. **A Test Class for New List Creation**。把lists/tests.py下的test_can_save_a_POST_request和test_redirects_after_POST函数移动到该文件内新建的NewListTest类下并把client.post('/',修改为self.client.post('/lists/new',并修改第二个函数如下。运行单元测试`manage.py test lists`会提示 AssertionError: 0 != 1和AssertionError: 404 != 302 : Response didn''t redirect as expected: Response code was 404 (expected 302)两个错误。
```python
def test_redirects_after_POST(self):
    response = self.client.post('/lists/new', data={'item_text': 'A new list item'})
    self.assertRedirects(response, '/lists/the-only-list-in-the-world/') 
```

13. **A URL and View for New List Creation**。修改urls.py中的部分内容为如下。运行单元测试`manage.py test lists`会提示 AttributeError: module 'lists.views' has no attribute 'new_list'
```python
   url(r'^$', views.home_page, name='home'),
   url(r'^lists/new$', views.new_list, name='new_list'),
   url(r'^lists/the-only-list-in-the-world/$', views.view_list, name='view_list'),
```

15. views.py中添加函数和代码如下，运行单元测试`manage.py test lists`后会提示
ValueError: The view lists.views.new_list didn''t return an HttpResponse object. It returned None instead。第二行代码改为`return redirect('/lists/the-only-list-in-the-world/')`，运行单元测试`manage.py test lists`会提示AssertionError: 0 != 1。第二行代码改为下方代码，运行单元测试`manage.py test lists`会提示Ran 7 tests in 0.060s和OK。运行功能测试`python manage.py test functional_tests`后会提示AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy milk']和Ran 2 tests in 24.343s和FAILED (failures=2)。
```python
def new_list(request):
	pass
```

```python
	Item.objects.create(text=request.POST['item_text'])
	return redirect('/lists/the-only-list-in-the-world/')
```

16. **Removing Now-Redundant Code and Tests**。简化views.py中的home_page部分，只剩下`return render(request, 'home.html')`。删除lists/tests.py下冗余的`test_only_saves_items_when_necessary`函数。运行单元测试`manage.py test lists`会提示Ran 6 tests in 0.047s和OK，运行功能测试`python manage.py test functional_tests`提示错误selenium.common.exceptions.NoSuchElementException: Message: no such element: Unable to locate element: {"method":"id","selector":"id_list_table"}等。
17. **A Regression! Pointing Our Forms at the New URL**。修改home.html和lists.heml中的代码为`<form method="POST" action="/lists/new">`，运行功能测试`python manage.py test functional_tests`会提示AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy milk']和Ran 2 tests in 24.921s和FAILED (failures=2)等。

## 第七章续 4.30.2019

> 总结，在home——page所有显示出来，生成新的页面list从homepage提交的东西建立新的list在里面把item加进去。通过建立新的list页面来实现，把homepage显示的item都在list，都在list网页里面。做完后发现用户不能分开，所有人的item都显示在list里面，只是从homepage到list里面。接着新的用户进来形成新的url页面，不要混起来，为新的用户建立新的url。老用户需要在已经有的list需要加新的list。

18. **Biting the Bullet: Adjusting Our Models**。修改lists/tests.py的class ItemModelTest(TestCase)为ListAndItemModelsTest(TestCase)，并在其中添加多行代码，见7.pdf的114页。运行单元测试`manage.py test lists`，首先会提示ImportError: cannot import name 'List'，在models.py中添加如下代码，运行单元测试`manage.py test lists`后会提示AttributeError: 'List' object has no attribute 'save'。修改代码为如下下方代码，运行单元测试`manage.py test lists`后会提示django.db.utils.OperationalError: no such table: lists_list。
```python
    class List(Object):
        pass
```

```python
	class List(models.Model):
   		pass
```

19. 进行数据库迁移`python manage.py makemigrations`会显示如下内容。接着models.py中添加如下中间代码，运行单元测试`python manage.py test lists`后会提示AssertionError: 'List object (1)' != <List: List object (1)>。将其中一行改成`list = models.ForeignKey(List, default=None)`，接着改成`list = models.ForeignKey(List, on_delete=models.CASCADE ,default=None)`。输入`rm suplerlists\lists\0003_auto_20190430_1908.py`来删除迁移，或者直接在资源管理器中删除。再次进行数据库迁移`python manage.py makemigrations`，运行单元测试`manage.py test lists`，其中会有sqlite3.IntegrityError: NOT NULL constraint failed: lists_item.list_id和FAILED (errors=3)提示。最终models.py中代码见下方最下。
```
   Migrations for 'lists':
  lists\migrations\0003_auto_20190430_1908.py
    - Create model List
    - Add field list to item
```

```python
class Item(models.Model):
    text = models.TextField(default='')
    list = models.TextField(default='')
```

```python
class List(models.Model):
    pass
class Item(models.Model):
    text = models.TextField(default='')
    list = models.ForeignKey(List, on_delete=models.CASCADE,default=None)
```

20. 在views.py中添加如下内容。运行单元测试，Ran 6 tests in 0.044s成功。
```python
from lists.models import Item, List
def new_list(request):
    list_ = List.objects.create()
    Item.objects.create(text=request.POST['item_text'], list=list_)
    return redirect('/lists/the-only-list-in-the-world/')
```

21. 运行功能测试python manage.py test functional_tests，会提示AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy milk']错误。
> session not created: Chrome version must be between 70 and 73
> 需要在https://sites.google.com/a/chromium.org/chromedriver/downloads
> 下载和chrome浏览器适配的版本

22. **Each List Should Have Its Own URL**。修改lists/tests.py中的函数如下，见7.pdf的120页。运行单元测试`manage.py test lists`会提示AssertionError: 404 != 200 : Couldn''t retrieve content: Response code was 404 (expected 200)。和AssertionError: No templates used to render the response。

23. 把urls.py中部分代码修改为如下，运行单元测试`manage.py test lists`，会提示TypeError: view_list() takes 1 positional argument but 2 were given。views.py中def view_list(request)改成`def view_list(request,list_id)`后运行单元测试`manage.py test lists`，AssertionError: 1 != 0 : Response should not contain 'other list item 1'。接着把views.py中`def view_list(request, list_id)`函数改成下方代码，运行单元测试会提示ValueError: invalid literal for int() with base 10: 'the-only-list-in-the-world'。
```python
url(r'^$', views.home_page, name='home'),
url(r'^lists/new$', views.new_list, name='new_list'),
url(r'^lists/(.+)/$', views.view_list, name='view_list'),
```

```python
list_ = List.objects.get(id=list_id)
items = Item.objects.filter(list=list_)
return render(request, 'list.html', {'items': items})
```

23. **Adjusting new_list to the New World**。将lists/tests.py中`def test_redirects_after_POST(self)`改成如下代码。单元测试`manage.py test lists`后提示ValueError: invalid literal for int() with base 10: 'the-only-list-in-the-world'。将views.py中`def new_list(request)`函数改成下方代码。运行单元测试`manage.py test lists`，提示Ran 6 tests in 0.054s和OK。
```python
	response = self.client.post('/lists/new', data={'item_text': 'A new list item'})
	new_list = List.objects.first()
	self.assertRedirects(response, f'/lists/{new_list.id}/')
```

```python
    list_ = List.objects.create()
    Item.objects.create(text=request.POST['item_text'], list=list_)
    return redirect(f'/lists/{list_.id}/')
```

24. **The Functional Tests Detect Another Regression**。运行功能测试`python manage.py test functional_tests`，会提示AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Use peacock feathers to make a fly']和Ran 2 tests in 25.364s。

25. **One More View to Handle Adding Items to an Existing List**。在lists/tests.py添加7.pdf的12页的内容。运行单元测试`manage.py test lists`，提示AssertionError: 301 != 302 : Response didn''t redirect as expected: Response code was 301 (expected 302)。

26. **Beware of Greedy Regular Expressions!**。urls.py中一行改成`url(r'^lists/(\d+)/$', views.view_list, name='view_list')`,运行单元测试`manage.py test lists`，提示AssertionError: 404 != 302 : Response didn''t redirect as expected: Response code was 404 (expected 302)

27. **The Last New URL**。修改urls.py部分内容如下，运行单元测试`manage.py test lists`，提示AttributeError: module 'lists.views' has no attribute 'add_item'
```python
    url(r'^$', views.home_page, name='home'),
    url(r'^lists/new$', views.new_list, name='new_list'),
    url(r'^lists/(\d+)/$', views.view_list, name='view_list'),
    url(r'^lists/(\d+)/add_item$', views.add_item, name='add_item'),
```

28. **The Last New View**。在views.py中添加代码直到改成7.pdf的126页，代码如下。运行单元测试`manage.py test lists`，提示Ran 8 tests in 0.047s和OK。
```python
def add_item(request, list_id):
list_ = List.objects.get(id=list_id)
Item.objects.create(text=request.POST['item_text'], list=list_)
return redirect(f'/lists/{list_.id}/')
```

29. **Testing the Response Context Objects Directly**。在lists/templates/list.html中修改一行为`<form method="POST" action="/lists/{{ list.id }}/add_item">`。在lists/views.py添加新的单元测试，见7.pdf的127页。可以添加到NewItemTest的class中。运行单元测试`manage.py test lists`，提示KeyError: 'list'。将views.py中`def view_list(request,list_id)`简化为如下中间代码，运行单元测试`manage.py test lists`，提示AssertionError: False is not true : Couldn''t find 'itemey 1' in response。将lists.html中修改一行为如下最下代码。运行单元测试`manage.py test lists`，提示Ran 9 tests in 0.062s和OK。运行功能测试`python manage.py test functional_tests`，提示Ran 2 tests in 15.338s和OK。
```python
def test_passes_correct_list_to_template(self):
    other_list = List.objects.create()
    correct_list = List.objects.create()
    response = self.client.get(f'/lists/{correct_list.id}/')
    self.assertEqual(response.context['list'], correct_list)
```

```python
def view_list(request, list_id):
list_ = List.objects.get(id=list_id)
return render(request, 'list.html', {'list': list_})
```

```python
   {啊% for item in list.item_set.all %啊}
        <tr><td>{{ forloop.counter }}: {{ item.text }}</td></tr>
   {啊% endfor %啊}
```

30. **A Final Refactor Using URL includes**。在superlists/urls.py中修改代码为如下。新建lists/urls.py，代码见下方。运行单元测试`manage.py test lists`，提示Ran 9 tests in 0.054s和OK。运行功能测试`python manage.py test functional_tests`，提示Ran 2 tests in 15.697s和OK。
```python
from django.conf.urls import include, url
from lists import views as list_views
from lists import urls as list_urls
urlpatterns = [
    url(r'^$', list_views.home_page, name='home'),
    url(r'^lists/', include(list_urls)),
]
```

```python
from django.conf.urls import url
from lists import views
urlpatterns = [
    url(r'^new$', views.new_list, name='new_list'),
    url(r'^(\d+)/$', views.view_list, name='view_list'),
    url(r'^(\d+)/add_item$', views.add_item, name='add_item'),
]
```

## 第八章 2019.5.14

1. 使用”suplerlists - 安装到服务器前备份，完成了第七章“文件夹，简称suplerlists2。在functional_tests/tests.py中添加以下函数。运行功能测试`python manage.py test functional_tests`，分别提示了.F.和AssertionError: 94.5 != 512 within 10 delta和Ran 3 tests in 21.475s。
```python
    def test_layout_and_styling(self):
        # Edith goes to the home page
        self.browser.get(self.live_server_url)
        self.browser.set_window_size(1024, 768)
        # She notices the input box is nicely centered
        inputbox = self.browser.find_element_by_id('id_new_item')
        self.assertAlmostEqual(
            inputbox.location['x'] + inputbox.size['width'] / 2,
            512,
            delta=10
        )
```

2. 在lists/templates/home.html中添加`<p style="text-align: center;">`和`</p>`在指定位置，再运行功能测试`python manage.py test functional_tests`，提示OK。

3. 在functional_tests/tests.py中继续添加以下代码，运行功能测试`python manage.py test functional_tests`，会提示AssertionError: 94.5 != 512 within 10 delta和Ran 3 tests in 21.311s。
```python
    # She starts a new list and sees the input is nicely
    # centered there too
    inputbox.send_keys('testing')
    inputbox.send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: testing')
    inputbox = self.browser.find_element_by_id('id_new_item')
    self.assertAlmostEqual(
        inputbox.location['x'] + inputbox.size['width'] / 2,
        512,
        delta=10
    )
```

4. 回滚代码，删掉home.html内新添加的两行代码。

5. 使用bootstrap.zip，本地已有。新建文件夹`mkdir lists/static`，解压`mv bootstrap-3.3.4-dist lists/static/bootstrap`。可参考8.pdf的140页的文件树。

6. **Django Template Inheritance**。比较lists/templates/home.html和lists/templates/list.html不同。在lists/templates/下新建base.html，内容为以下代码。并修改homt.html和lists.html中的代码为如下中间和下方代码。运行功能测试`python manage.py test functional_tests`，会提示AssertionError: 94.5 != 512 within 10 delta错误。
```html
<html>
    <head>
        <title>To-Do lists</title>
    </head>
    
    <body>
        <h1>{啊% block header_text %啊}{啊% endblock %啊}</h1>
        <form method="POST" action="{啊% block form_action %啊}{啊% endblock %啊}">
            <input name="item_text" id="id_new_item" placeholder="Enter a to-do item" />
            {啊% csrf_token %啊}
        </form>
        {啊% block table %啊}
        {啊% endblock %啊}
    </body>
</html>
```

```html
{啊% extends 'base.html' %啊}
{啊% block header_text %啊}Start a new To-Do list{啊% endblock %啊}
{啊% block form_action %啊}/lists/new{啊% endblock %啊}
```

```html
{啊% extends 'base.html' %啊}
{啊% block header_text %啊}Your To-Do list{啊% endblock %啊}
{啊% block form_action %啊}/lists/{{ list.id }}/add_item{啊% endblock %啊}
{啊% block table %啊}
    <table id="id_list_table">
        {啊% for item in list.item_set.all %啊}
           <tr><td>{{ forloop.counter }}: {{ item.text }}</td></tr>
        {啊% endfor %啊}
    </table>
{啊% endblock %啊}
```

## 第八章续 2019.5.21

7. 复制上次步骤结果，使用suplerlists3进行接下来内容。**Integrating Bootstrap**。在lists/templates/base.html下添加以下内容。删掉原来的`<head>`等内容。
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>To-Do lists</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
</head>
```

8. **Rows and Columns**。继续修改知道下方代码。运行功能测试`python manage.py test functional_tests`，会提示`AssertionError: 94.5 != 512 within 10 delta`
```html
    <body>
        <div class="container">
         <div class="row">
          <div class="col-md-6 col-md-offset-3">
           <div class="text-center">
            <h1>{啊% block header_text %啊}{啊% endblock %啊}</h1>
            <form method="POST" action="{啊% block form_action %啊}{啊% endblock %啊}">
             <input name="item_text" id="id_new_item" placeholder="Enter a to-do item" />
             {啊% csrf_token %啊}
            </form>
           </div>
          </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 col-md-offset-3">
             {啊% block table %啊}
             {啊% endblock %啊}
            </div>
        </div>
      </div>
    </body>
```

9. 修改为lists/templates/base.html中一行为`<link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">`，可手动在浏览器中打开`http://localhost:8000/`，会看到Start a new To-Do list在页面居中了，但不能添加数据。运行功能测试`python manage.py test functional_tests`，会提示AssertionError: 94.5 != 512 within 10 delta。

10. **Switching to StaticLiveServerTestCase**。修改functional_tests/tests.py文件中两行为`from django.contrib.staticfiles.testing import StaticLiveServerTestCase`和`class NewVisitorTest(StaticLiveServerTestCase):`。运行功能测试`python manage.py test functional_tests`，会提示Ran 3 tests in 21.068s和OK。

> 如果遇到`[WinError 10054] 远程主机强迫关闭了一个现有的连接。`错误，在def tearDown(self)函数self.browser.quit()前添加 self.browser.refresh()函数即可。还是不行？

11. **Jumbotron!**。lists/templates/base.html中修改一行为`<div class="col-md-6 col-md-offset-3 jumbotron">`。**Large Inputs**。继续修改base.html，input中加入`class="form-control input-lg"`。**Table Styling**。lists/templates/list.html中修改一行为`<table id="id_list_table" class="table">`。浏览器打开`http://localhost:8000/`可以看到`Start a new To-Do list`和输入框会变大。

12. **Using Our Own CSS**，base.html中添加一行`<link href="/static/base.css" rel="stylesheet">`，在lists/static下新建base.css文件，内容为`#id_new_item {    margin-top: 2ex;}`。浏览器打开`http://localhost:8000/`可以看到整体会有2个x高度的偏移。运行功能测试`python manage.py test functional_tests`，会提示Ran 3 tests in 21.130s和OK。

13. **What We Glossed Over: collectstatic and Other Static
Directories**。uperlists/settings.py中添加一行`STATIC_ROOT = os.path.abspath(os.path.join(BASE_DIR, '../static'))`。

14. 尝试运行`python manage.py collectstatic`，提示`134 static files copied to 'E:\文档2\研究生\09GitHub\21 _Software Testing Technology\static'`。通过#注释禁用`INSTALLED_APPS`内的 `django.contrib.admin`。通过`rm -rf ../static/`命令删除根目录（与项目文件夹suplerlists3平级）下的static文件夹，输入`python manage.py collectstatic --noinput`提示`15 static files copied to 'E:\文档2\研究生\09GitHub\21 _Software Testing Technology\static'`，即把`E:\文档2\研究生\09GitHub\21 _Software Testing Technology\suplerlists3\lists\static`下的内容拷贝到了`'E:\文档2\研究生\09GitHub\21 _Software Testing Technology\static'`。


## 第九章 2019.5.21

0. 在https://promotion.aliyun.com/ntms/act/campus2018.html 选择购买云服务器ECS。设置root的密码，要求包括大小写字母与数字。进入云服务器管理控制台，选择新购买的实例。在操作栏中选择远程连接，记录并输入6位数字远程连接密码。

1. **As Always, Start with a Test**。在functional_tests/tests.py中添加以下代码。本地运行功能测试`python manage.py test functional_tests`，会提示Ran 3 tests in 21.706s和OK。通过在本地输入`STAGING_SERVER=39.96.9.216 python manage.py test functional_tests`来运行在服务区上的功能测试。win10不行？
```python
import os
staging_server = os.environ.get('STAGING_SERVER')
if staging_server:
	self.live_server_url = 'http://' + staging_server
```

2. **Spinning Up a Server**。打开xshell连接到阿里云服务器， 依次输入以下命令，并在必要时选择Y或者install the package maintainer''s version。完成后在浏览器中输入服务器实例的公网IP，如http://39.96.9.216/ 。可以看到如下下方内容。也有可能80端口没开，需要在阿里云控制台打开。
```shell
    apt-get update
    apt-get upgrade
    sudo apt-get install nginx
    sudo systemctl start nginx
```

```
>   Welcome to nginx!
>   If you see this page, the nginx web server is successfully installed and working. Further configuration is required.
>   For online documentation and support please refer to >[nginx.org](http://nginx.org/).
>   Commercial support is available at [nginx.com](http://nginx.com/).
>   *Thank you for using nginx.*
```

3. 输入sudo add-apt-repository ppa:fkrull/deadsnakes提示command not found，需要输入以下命令，参考https://www.jianshu.com/p/e50e6d46ea62
```shell
sudo apt-get install python-software-properties
sudo apt-get install software-properties-common
```

4. 依次输入以下命令，并在必要时按ENTER或者输入Y。在本地输入`STAGING_SERVER=39.96.9.216 python3 manage.py test functional_tests`进行功能测试，WIN10不行。
```shell
sudo add-apt-repository ppa:fkrull/deadsnakes
sudo apt-get update
sudo apt-get install python3.6 python3.6-venv
sudo apt-get install git
```

```python
STAGING_SERVER=39.96.9.216 python3 manage.py test functional_tests ##有服务器后在本地功能测试
```

## 第九章续 2019.5.28

4. 申请一个非root用户。在服务器中以root用户登陆后输入`useradd zhang`和`passwd zhang` 后输入密码`123`。

  > 如提示could not chdir to home directory，以账户zhang为例，需使用root账户。
  >
  > **重新创建该用户home目录**
  > 执行`mkdir -p /home/zhang`创建账号zhang的home目录/home/zhang
  > **授予该目录此账号权限**
  > 执行`chown zhang -R /home/zhang` 改变/home/zhang的属主为zhang
  > 　　`chgrp zhang -R /home/zhang` 改变/home/zhang的属组为zhang
  > 参考http://www.023dns.com/server_ECS/2750.html 。

5. **Deploying Our Code Manually**。修改superlists/settings.py下一行为`'NAME': os.path.join(BASE_DIR, '../database/db.sqlite3'),`。在Linux shell中输入`mkdir ../database`，在Cmd中输入`python manage.py migrate --noinput`，在Linux shell中输入`ls ../database/`可以看到db.sqlite3文件。

6. 使用新建的用户名zhang（下同）在服务器的/home/zhang/目录下依次输入以下命令。
```shell
  export SITENAME=39.96.9.216
  mkdir -p ~/sites/$SITENAME/database
  mkdir -p ~/sites/$SITENAME/static
  mkdir -p ~/sites/$SITENAME/virtualenv
```
    > 在重启控制台后需要重新设置局部变量`export SITENAME=39.96.9.216`

7. 导入自己的或者老师的github代码，`git clone https://github.com/zhang99969/suplerlists.git \ 
~/sites/$SITENAME/source` 或者
`git clone https://github.com/yuanyuyu/-TDD.git \
~/sites/$SITENAME/source`
，此处拉老师的代码。提示如下，此时在**/home/zhang/sites/39.96.9.216/**目录下有database、source、static和virtualenv文件夹。source文件夹内为拉取的代码。空格加\代表换行。

```
$ git clone https://github.com/yuanyuyu/-TDD.git \
~/sites/$SITENAME/source> 
Cloning into '/home/zhang/sites/39.96.9.216/source'...
remote: Enumerating objects: 167, done.
remote: Counting objects: 100% (167/167), done.
remote: Compressing objects: 100% (87/87), done.
remote: Total 167 (delta 72), reused 166 (delta 71), pack-reused 0
Receiving objects: 100% (167/167), 276.55 KiB | 290.00 KiB/s, done.
Resolving deltas: 100% (72/72), done.
Checking connectivity... done.
```

> **本地多个仓库与远程多个仓库连接的创建与切换方法**
> 创建新的本地仓库，存放suplerlists。在github中创建suplerlists仓库。
> 在本地仓库目录下使用git bash
> echo "# suplerlists" >> README.md
> git init
> git add README.md
> git commit -m "first commit"
> git remote add origin https://github.com/zhang99969/suplerlists.git
> git push -u origin master
> 在github仓库中可以看到README.md文件。接着输入以下代码后可以在github仓库中看到上传的代码。
> git add .
> git status
> git commit -m "add codes"
> git push -f origin master
>
> (在本地使用git bash时切换仓库路径以"/"表示)
>
> (也可以使用Xshell连接服务器后，使用Xftp在对应的路径上传代码。后面就不可以了)

8. 在/home/zhang/sites/39.96.9.216/source目录下（通过pwd命令查看）输入`python3.6 manage.py runserver`，不能运行。

9.  在git bash中本地仓库目录下输入以下代码。**接着**在服务器远程连接终端(或者Xshell终端)中输入`git pull`。
```shell
echo "django==2.1.7" > requirements.txt
git add requirements.txt
git commit -m "Add requirements.txt for virtualenv"
git push
```

10. 在服务器远程连接终端中输入`pwd`显示**/home/zhang/sites/39.96.9.216/source**，依次输入以下代码，会看到下方内容。**接着**输入`../virtualenv/bin/pip install -r requirements.txt`来下载Django（和gunicorn）并耐心等待。
```shell
python3.6 -m venv ../virtualenv
ls ../virtualenv/bin
```

    >activate      activate.fish  easy_install-3.6  pip3    python   python3.6
    >activate.csh  easy_install   pip               pip3.6  python3

11. 在服务器远程连接终端中输入`../virtualenv/bin/python manage.py runserver`提示以下内容。在虚拟环境下启动了服务器。

>Performing system checks...
>
>System check identified no issues (0 silenced).
>
>You have 16 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): auth, contenttypes, lists, sessions.
>Run 'python manage.py migrate' to apply them.
>
>May 28, 2019 - 11:30:54
>Django version 2.1.7, using settings 'superlists.settings'
>Starting development server at http://127.0.0.1:8000/
>Quit the server with CONTROL-C.


12. **Simple Nginx Configuration**。在Xftp中打开/etc/nginx/sites-available/路径，并新建39.96.9.216文件，内容为下。
    
    >server {
    >	listen 80;
    >	server_name 39.96.9.216;
    >	location / {
    >	proxy_pass http://localhost:8000;
    >    }
>}

13. 依次在服务器远程连接终端中输入下方上面命令。首先查看局部变量是否还存在，接着创建一个快捷方式。最后一条命令会提示下方中间内容。**接着**输入下方下面的命令，来删掉default。
```shell
echo $SITENAME #查看是否还存在
sudo ln -s ../sites-available/$SITENAME /etc/nginx/sites-enabled/$SITENAME
ls -l /etc/nginx/sites-enabled
```
    >lrwxrwxrwx 1 root root 30 May  9 13:51 39.96.9.216 -> ../sites-available/39.96.9.216
    >lrwxrwxrwx 1 root root 34 May  9 10:34 default -> /etc/nginx/sites-available/default

```shell
sudo rm /etc/nginx/sites-enabled/default
```

14. 接着在服务器远程连接终端中使用zhang用户在/home/zhang/sites/39.96.9.216/source目录下输入以下命令。在浏览器中打开http://39.96.9.216/ 即可以看到之前编写的网页了。
```shell
sudo rm /etc/nginx/sites-enabled/default
../virtualenv/bin/python manage.py runserver
```

15. 在本地通过`STAGING_SERVER=39.96.9.216 python manage.py test functional_tests`运行功能测试，会提示不通过。数据库还没有进行设置。

16.  **Creating the Database with migrate**。在网站中输入内容后会报错，需要migrate。依次输入以下代码。此时可以在本地进行功能测试。
```shell
../virtualenv/bin/python manage.py migrate --noinput
ls ../database
../virtualenv/bin/python manage.py runserver
```

>使用**../virtualenv/bin/python manage.py runserver**启动服务器。也可以用nginx start或 sudo systemctl start nginx开 **?**

17. 在本地连接服务器进行功能测试，使用`STAGING_SERVER=39.96.9.216 python manage.py test functional_tests`命令。修改tests.py代码后，使用`python manage.py test functional_tests`运行功能测试，提示Ran 3 tests in 21.539s和OK和Destroying test database for alias 'default'...。

> 关于`STAGING_SERVER=39.96.9.216 python manage.py test functional_tests`
>
> 在服务器运行本代码会出现`from exc ^ SyntaxError: invalid syntax`错误。尝试1：编辑manage.py倒数第二行，删掉from exc。尝试2：apt install python3-pip和pip3 intsall django。是由于是在服务器输入的代码，本代码应在本地运行。
>
> Windows似乎不支持带参数运行代码，改成`python manage.py test functional_tests STAGING_SERVER=39.96.9.216`也不行，`STAGING_SERVER`只能接收到`39`。
>
> 解决1：修改functional_tests/tests.py代码部分如下。需要功能测试时直接在本地使用`python manage.py test functional_tests`。
>
> ```python
> def setUp(self):
>     self.browser = webdriver.Chrome()
>     staging_server = os.environ.get('STAGING_SERVER')
>     #if staging_server:
>     #    self.live_server_url = 'http://' + staging_server
>     self.live_server_url='http://39.96.9.216'
> ```

> **在服务器运动功能测试或单元测试**
> 一般需要在/home/zhang/sites/39.96.9.216/source目录下运行命令。建议使用zhang用户。
> ```python
> ../virtualenv/bin/python manage.py test functional_tests #在服务器功能测试
> ../virtualenv/bin/python manage.py test lists #在服务器单元测试
> ```

## 第十章 2019.5.28

1. **Switching to Gunicorn**。还是在/home/zhang/sites/39.96.9.216/source路径下以zhang用户名输入`../virtualenv/bin/pip install gunicorn`，在前面requirements中已经安装。
2. 在服务器输入`../virtualenv/bin/gunicorn superlists..wsgi:application`会提示No module named 'suplerlists'错误，找到/home/zhang/sites/39.96.9.216/source/superlists下的wsgi.py，修改一行为`os.environ.setdefault("DJANGO_SETTINGS_MODULE", "superlists.settings")`。重新输入`../virtualenv/bin/gunicorn superlists.wsgi:application`后打开浏览器http://39.96.9.216/ 可以看到页面css格式消失了。

## 第十章续 2019.6.4

3. **Getting Nginx to Serve Static Files**。在服务器上收集静态文件，在/home/zhang/sites/39.96.9.216/source路径下输入`../virtualenv/bin/python manage.py collectstatic --noinput`会看到下方内容。接着输入`ls ../static/`可以看到base.css和bootstrap。
```shell
Copying '/root/sites/39.96.9.216/source/lists/static/base.css'
Copying '/root/sites/39.96.9.216/source/lists/static/bootstrap/fonts/glyphicons-halflings-regular.woff'
略
```

4. 在Xftp中打开/etc/nginx/sites-available/路径，打开39.96.9.216文件，添加一行如下内容。
```
location /static {
alias /home/elspeth/sites/39.96.9.216/static;
}
```

5. ps -aux | grep python后显示一下内容，输入kill 17967来重启nginx。在/home/zhang/sites/39.96.9.216/source路径下输入`sudo systemctl reload nginx`和`../virtualenv/bin/gunicorn superlists.wsgi:application`，在本地输入修改后的`python manage.py test functional_tsets`进行功能测试，提示Ran 3 tests in 22.053s和OK。
```shell
root     17967  0.0  1.0  62396 22048 ?        S    May28   1:21 /home/zhang/sites/39.96.9.216/virtualenv/bin/python3.6 ../virtualenv/bin/gunicorn superlists.wsgi:application
root     17973  0.0  1.7  96220 35136 ?        S    May28   0:09 /home/zhang/sites/39.96.9.216/virtualenv/bin/python3.6 ../virtualenv/bin/gunicorn superlists.wsgi:application
root     25698  0.0  0.0  14224  1016 pts/1    S+   19:01   0:00 grep --color=auto python
root@iZ2zedo2pcwg3c5fgo6l7pZ:/home/zhang/sites/39.96.9.216/source# ../virtualenv/bin/gunicorn superlists.wsgi:application
```

6. **Switching to Using Unix Sockets**。在Xftp中打开/etc/nginx/sites-available/路径，打开39.96.9.216文件，下面改成如下内容。**接着**使用Ctrl+C中断，在/home/zhang/sites/39.96.9.216/source路径下输入输入`sudo systemctl reload nginx`和`../virtualenv/bin/gunicorn --bind \ unix:/tmp/39.96.9.216.socket superlists.wsgi:application`。在本地运行功能测试`python manage.py test functional_tests`，提示Ran 3 tests in 21.055s和OK。
```
proxy_set_header Host $host;
proxy_pass http://unix:/tmp/39.96.9.216.socket;
```

>如遇到Invalid HTTP_HOST header: '39.96.9.216'. You may need to add '39.96.9.216' to ALLOWED_HOSTS和浏览器显示DisallowedHost at / ，需要将服务器内的suplerlists/settings.py内一行修改为`ALLOWED_HOSTS = ['*']`。

7. 将服务器内的suplerlists/settings.py内几行修改为以下内容。**接着**使用Ctrl+C中断，/home/zhang/sites/39.96.9.216/source路径下输入输入`sudo systemctl reload nginx`和`../virtualenv/bin/gunicorn --bind \ unix:/tmp/39.96.9.216.socket superlists.wsgi:application`。在本地运行功能测试`python manage.py test functional_tests`，提示Ran 3 tests in 20.539s和OK。
```python
DEBUG = False
TEMPLATE_DEBUG = DEBUG
ALLOWED_HOSTS = ['39.96.9.216']
```

8. **Using Systemd to Make Sure Gunicorn Starts on Boot**。在/etc/systemd/system目录下新建gunicorn-39.96.9.216.service文件，内容如下。**接着**使用Ctrl+C中断，依次输入`sudo systemctl daemon-reload`、`sudo systemctl enable gunicorn-39.96.9.216`和`sudo systemctl start gunicorn-39.96.9.216`命令，其中第二条命令输入完后会显示下面下方内容，在本地运行功能测试`python manage.py test functional_tests`，提示Ran 3 tests in 20.564s和OK。
```
[Unit]
Description=Gunicorn server for 39.96.9.216

[Service]
Restart=on-failure
User=zhang
WorkingDirectory=/home/zhang/sites/39.96.9.216/source
ExecStart=/home/zhang/sites/39.96.9.216/virtualenv/bin/gunicorn \
	--bind unix:/tmp/39.96.9.216.socket \
	superlists.wsgi:application

[Install]
WantedBy=multi-user.target
```

```shell
Created symlink from /etc/systemd/system/multi-user.target.wants/gunicorn-39.96.9.216.service to /etc/systemd/system/gunicorn-39.96.9.216.service.
```

> 以后输入sudo systemctl start gunicorn-39.96.9.216就可以字服务器启动网页。？

9. **Saving Our Changes: Adding Gunicorn to Our requirements.txt**。本地Anaconda Prompt内输入`pip install gunicorn`来安装。输入一下内容，具体略。
```
pip freeze | grep gunicorn >> requirements.txt
git commit -am "Add gunicorn to virtualenv requirements"
git push
```

10. 在本地21 _Software Testing Technology\suplerlists3\新建deploy_tools文件夹，接着新建nginx.template.conf文件、gunicorn-systemd.template.servicef文件和provisioning_notes.md文件，内容见10.pdf的182页和183页。注意修改其中的用户名为下面的用户名。

## 第十一章 2019.6.4

10. 本地Anaconda Prompt内输入`pip install fabric3`进行安装。在本地`21 _Software Testing Technology\suplerlists3\deploy_tools`下新建fabfile.py文件，内容见https://github.com/yuanyuyu/-TDD/tree/master/deploy_tools 。注意在本地代码的fabfile.py中，注释掉了`run(f'cd {source_folder} && git reset --hard {current_commit}')，因为一直有错误。

11. **Trying It Out**。在本地Anaconda Prompt内`21 _Software Testing Technology\suplerlists3`下输入`cd deploy_tools`和`fab deploy:host=zhang@39.96.9.216`，进行自动部署。也可以用别的账号，比如root，会在/home下新建/root文件。这样就不用管之前手动部署的zhang的内容，但要注意以下步骤中服务器下/etc/nginx/sites-available/39.96.9.216和/etc/systemd/system/gunicorn-39.96.9.216.service文件的用户名为zhang或者是root。现在输入`fab deploy:host=root@39.96.9.216`。

12. 在服务器/home/root/sites/39.96.9.216目录下依次输入以下代码。
```shell
sed "s/SITENAME/39.96.9.216/g" source/deploy_tools/nginx.template.conf | sudo tee /etc/nginx/sites-available/39.96.9.216
sudo ln -s ../sites-available/39.96.9.216 /etc/nginx/sites-enabled/39.96.9.216
sed "s/SITENAME/39.96.9.216/g" source/deploy_tools/gunicorn-systemd.template.service | sudo tee /etc/systemd/system/gunicorn-39.96.9.216.service
```

13. 依次输入以下代码来进行启动，打开浏览器输入http://39.96.9.216/ ，成功。
```shell
sudo systemctl daemon-reload
sudo systemctl reload nginx
sudo systemctl enable gunicorn-39.96.9.216
sudo systemctl start gunicorn-39.96.9.216
```

## 第十二章


> 留下你的评论
> Your text here