<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>D3js test step page</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <!-- Custom styles for this template -->
    <style type="text/css">
        .table td, .table th {
            padding: 12px;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row" style="height:70px; margin-bottom: 15px"; >
        <div class="col col-10 col-md-10 form-inline" style="background-color:lavender;"><h1>分析测试用例</h1></div>
        <div class="col col-1 col-md-1 form-inline" style="background-color:lavender;">
            <a href="query.html"><button type="button" class="btn btn-outline-primary" id="btnHome" style="background-color: white">
                <i class="fa fa-home" aria-hidden="true"></i>
            </button></a>
        </div>
        <div class="col col-1 col-md-1 form-inline" style="background-color:lavender;">
            <a href="javascript:history.back(-1)"> <button type="button" class="btn btn-outline-primary" id="btnBack" style="background-color: white;">
                <i class="fa fa-backward" aria-hidden="true"></i>
            </button></a>
        </div>
    </div>
</div>

<div class="container-fluid">

    <div class="row" style="margin-left: 30px;margin-right: 50px" >
        <h5><div id="node">测试用例图示</div></h5>
    </div>
    <div id="nodegraph" style="margin-left: 30px;margin-right: 50px">    </div>
    <hr  />
    <div class="row" style="margin-left: 30px;margin-right: 50px" >
        <h5><div id="nodeInfo">测试用例信息</div></h5>
    </div>

    <div id="nodeInfoTable"  class="col col-12 col-md-12">
        <table id="tableInfo" class="table table-hover" style="word-break:break-all;word-wrap:break-word;padding-right: 30px;"></table>
    </div>

    <div class="row">
        <div class="col col-12 col-md-12 form-inline" style="padding-bottom: 15px">
            <div class="col col-2 col-md-2 form-inline">            </div>
            <div class="col col-2 col-md-2 form-inline">            </div>
            <div class="col col-2 col-md-2 form-inline">            </div>
            <div class="col col-2 col-md-2 form-inline">            </div>
            <div class="col col-2 col-md-2 form-inline">            </div>
            <div class="col col-2 col-md-2 form-inline">
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnShowFault"  >
                    查看测试记录和缺陷
                </button>
            </div>

        </div>
    </div>

</div>



<!-- jQuery first, then Popper.js, then Bootstrap JS -->

<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/jquery.params.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/d3.v5.min.js"></script>
<script src="js/d3js-example-neo4j.js"></script>
<script type="text/javascript">
    "use strict";

    var neo4jNodeItm;
    var neo4jAPIURL = 'http://localhost:7474/db/data/transaction/commit';
    var datainfo =  " <table>";


    /**
     * 合并单元格(如果结束行传0代表合并所有行)
     * @param table1    表格的ID
     * @param startRow  起始行
     * @param endRow    结束行
     * @param col   合并的列号，对第几列进行合并(从0开始)。第一行从0开始
     */
    function mergeCell(table1, startRow, endRow, col) {
        var tb = document.getElementById(table1);
        if(!tb || !tb.rows || tb.rows.length <= 0) {
            return;
        }
        if(col >= tb.rows[0].cells.length || (startRow >= endRow && endRow != 0)) {
            return;
        }
        if(endRow == 0) {
            endRow = tb.rows.length - 1;
        }
        for(var i = startRow; i < endRow; i++) {
            if(tb.rows[startRow].cells[col].innerHTML == tb.rows[i + 1].cells[col].innerHTML) { //如果相等就合并单元格,合并之后跳过下一行
                tb.rows[i + 1].removeChild(tb.rows[i + 1].cells[col]);
                tb.rows[startRow].cells[col].rowSpan = (tb.rows[startRow].cells[col].rowSpan) + 1;
            } else {
                mergeCell(table1, i + 1, endRow, col);
                break;
            }
        }
    }

    /*
    参数:table或tbody的id,开始行号，结束行号，合并哪一列
    mc('field_selection', 0, 4, 0);
    */
    function mc(table1, startRow, endRow, col) {
        var tb = document.getElementById(table1);
        let tableCellLength = tb.rows[0].cells.length;
        for (let i = startRow; i < endRow; i++) {
            if (tb.rows[startRow].cells[col].innerHTML == tb.rows[i + 1].cells[col].innerHTML) {
                //合并最后一列相同的行
                tb.rows[i + 1].removeChild(tb.rows[i + 1].cells[tableCellLength-1]);
                tb.rows[startRow].cells[tableCellLength-1].rowSpan = (tb.rows[startRow].cells[tableCellLength-1].rowSpan | 0) + 1;
                //合并第col列相同的行
                tb.rows[i + 1].removeChild(tb.rows[i + 1].cells[col]);
                tb.rows[startRow].cells[col].rowSpan = (tb.rows[startRow].cells[col].rowSpan | 0) + 1;
            }else{
                mc(table1, i + 1, endRow, col)
            }
        }
    }//mc(table1, startRow, endRow, col)


    function showteststep()
    {
    //console.log(this.value)
        var url = "teststep.html?id="+this.value;//此处拼接内容
        window.location.href = url;
    }

    function setTableInfo(data)
    {
        data += "</table>";

        document.getElementById("tableInfo").innerHTML = data;

        mc('tableInfo', 0, 3, 0);
          console.log("-----"+data);
    }


    function setButtons(nodelist){

        var nodeList = nodelist.split(",");
        for(var i=0;i<nodeList.length;i++)//结点 测试用例图示的生成与展示
        {
            //使用DOM的创建元素方法
            var o=document.createElement("input");
            o.type = "button" ;
            o.value = nodeList[i];
            o.className="btn btn-outline-primary btn-sm";//
            var left=53+i*100;
            o.style.cssText ="left:"+left+"px;width: 70px;height: 70px;border-radius:50%";//隔开
            o.addEventListener("click",showteststep);
            //document.body.appendChild(o);
            document.getElementById("nodegraph").appendChild(o);
            o = null;//及时解除不再使用的变量引用,即将其赋值为 null;

            if(i!=nodeList.length-1) {//显示每个结点按钮右侧的箭头
                var arrow = document.createElement("input");
                arrow.type = "button";
                arrow.value = "→";
                arrow.className = "btn btn-outline-primary btn-sm";//
                var left2 = 123 + i * 100;
                arrow.style.cssText = "left:" + left2 + "px;width: 30px;height: 30px;background-color:Transparent;border-style: none;outline:none;";//隔开
                document.getElementById("nodegraph").appendChild(arrow);
                //document.body.appendChild(arrow);
                arrow = null;
            }
        }

        for(var i=0;i<nodeList.length;i++) {//结点信息的获取与展示
            var queryStr =  'match (n)  where id(n) = ' + nodeList[i] + ' return n';
            var jqxhr = $.post(neo4jAPIURL, '{"statements":[{"statement":"' + queryStr + '", "resultDataContents":["graph"]}]}',
                function(data) {
                    // console.log(data);
                    if (data.results != null && data.results.length > 0 && data.results[0].data != null && data.results[0].data.length > 0) {

                        var neo4jDataItmArray = data.results[0].data;
                        neo4jDataItmArray.forEach(dataItem => {
                            neo4jNodeItm=dataItem.graph.nodes[0];
                         //   console.log(neo4jNodeItm);
                            var name=neo4jNodeItm.properties.ElementStoreName;
                            var name2="clickedIndex="+neo4jNodeItm.properties.clickedIndex+" action="+neo4jNodeItm.properties.action+" xpath="+neo4jNodeItm.properties.Elements_xpath;
                            datainfo += "<tr >";
                            datainfo += "<td><strong>结点" + neo4jNodeItm.id + "</td>";//不能用nodeList[i] ，为undefined
                            datainfo += "</strong></tr>";
                            datainfo += "<td><strong>"+name+"</td>";
                            datainfo += "</strong></tr>";
                            datainfo += "<td>"+name2+"</td>";
                            datainfo += "</tr>";
                        });
                    }
                }, 'json');
                    }
        setTimeout(function(){ setTableInfo(datainfo) },500);//延时等待




    }

    //Page Init
    $(function() {

        var neo4jLogin = 'neo4j';
        var neo4jPassword = 'password';

        //######################### variable #########################
        var id;
        var nodeItem;
        var neo4jNodeItm;


        var nodelist=sessionStorage.getItem('nodelist');
        console.log(nodelist);


        function submitQuery(nodeID) {




        }


        setupNeo4jLoginForAjax(neo4jLogin, neo4jPassword);
        setButtons(nodelist);

    });
</script>
</body>
</html>